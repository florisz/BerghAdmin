@using System.Linq;
@using Syncfusion.Blazor.Buttons

@using BerghAdmin.Data
@using BerghAdmin.Pages


@inject BerghAdmin.Services.IPersoonService persoonService
@inject BerghAdmin.Services.IRolService rolService

@inject NavigationManager NavigationManager
@inject IJSRuntime jsRuntime

<table>
    <tr>
        <td width="20%">Overzicht van:&nbsp</td>
        <td width="80%">
            <SfMultiSelect 
                    TValue="RolTypeEnum[]" 
                    TItem="Rol"
                    ClosePopupOnSelect="false" 
                    @bind-Value="@RolContext" 
                    Placeholder="e.g Ambassadeur, Fietser, Golfer"  
                    Mode="VisualMode.Box" 
                    DataSource="@rollenList"
                    Width="700px"
                    ShowDropDownIcon="true" 
                    ModelType="typeof(Rol)" >
                <MultiSelectFieldSettings Value="Id" Text="Beschrijving"></MultiSelectFieldSettings>
                <MultiSelectTemplates TItem="Rol">
                    <ItemTemplate>
                        @{
                            var contextValue = (context as Rol);
                            bool isChecked = RolContext != null ? RolContext.Contains(contextValue.Id) : false;

                            <span>
                                <SfCheckBox TChecked="bool" @bind-checked="@isChecked"></SfCheckBox>
                                @contextValue.Beschrijving
                            </span>
                        }
                    </ItemTemplate>
                </MultiSelectTemplates>
                <MultiSelectEvents 
                    TItem="Rol" 
                    TValue="RolTypeEnum[]" 
                    OnValueSelect="@OnValueSelectHandler"
                    ValueRemoved="@ValueRemovedHandler"
                    Cleared="@ClearedHandler">
                </MultiSelectEvents>
            </SfMultiSelect>
        </td>
    </tr>
</table>

@*
    The grid showing all persons
*@
<SfGrid @ref="@PersonenGrid" 
        DataSource="@personenList" 
        AllowPaging="true" 
        AllowResizing="true" 
        AllowSelection="true" 
        ShowColumnMenu="true" 
        ContextMenuItems="@(new List<ContextMenuItemModel>() { 
                                new ContextMenuItemModel { Text = "Wijzig persoon", Target = ".e-content", Id = "edit-persoon" },
                                new ContextMenuItemModel { Text = "Toevoegen persoon", Target = ".e-content", Id = "add-persoon" },
                                new ContextMenuItemModel { Text = "Send email", Target = ".e-content", Id = "send-email" },
                            })">
    <GridEditSettings 
        AllowAdding="true" 
        AllowDeleting="true" 
        AllowEditing="true" 
        Mode="EditMode.Dialog" 
        AllowEditOnDblClick="true">
    </GridEditSettings>
    <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Multiple" PersistSelection="true"></GridSelectionSettings>
    <GridEvents RowSelected="GetSelectedRecords" TValue="Persoon" />
    <GridEvents ContextMenuItemClicked="OnContextMenuClick" TValue="Persoon" />
    @* <GridEvents OnActionComplete="ActionCompletedHandler" TValue="Persoon" /> *@

    <GridColumns>
        <GridColumn Type="ColumnType.CheckBox" Width="25"></GridColumn>
        <GridColumn Field=@nameof(Persoon.Id) HeaderText="Id" TextAlign="TextAlign.Left" Width="0" IsPrimaryKey="true"></GridColumn>
        <GridColumn Field=@nameof(Persoon.VolledigeNaam) HeaderText="Naam" TextAlign="TextAlign.Left"  Width="110"></GridColumn>
        <GridColumn Field=@nameof(Persoon.GeboorteDatum) HeaderText="Geb.datum" Format="d" Type="ColumnType.Date" TextAlign="TextAlign.Left"  Width="70"></GridColumn>
        <GridColumn Field=@nameof(Persoon.Mobiel) HeaderText="Mobiel" TextAlign="TextAlign.Left"  Width="70"></GridColumn>
        <GridColumn Field=@nameof(Persoon.EmailAdres) HeaderText="Email" TextAlign="TextAlign.Left"  Width="120"></GridColumn>
        <GridColumn Field=@nameof(Persoon.GetRollenAsString) HeaderText="Rollen" TextAlign="TextAlign.Left"  Width="200"></GridColumn>
    </GridColumns>
</SfGrid>

<SendMailDialog @ref="sendMailDialog"></SendMailDialog>
<EditPersoonDialog @ref="editPersoonDialog"></EditPersoonDialog>

@code{
    [Parameter]
    public RolTypeEnum[] RolContext { get; set; }

    // Everything to handle the email dialog
    SendMailDialog sendMailDialog;
    private void ShowSendMailDialog()
    {
        sendMailDialog.DialogOpen();
    }

    // Everything to handle the edit persoon dialog
    EditPersoonDialog editPersoonDialog;

    // Everything to handle the context menu
    // Triggers when the item is selected
    public void OnContextMenuClick(ContextMenuClickEventArgs<Persoon> args)
    {
        if (args.Item.Id == "edit-persoon" || args.Item.Id == "add-persoon")
        {
            // open the edit dialog for a new or existing person
            var persoon = args.Item.Id == "edit-persoon" ? args.RowInfo.RowData as Persoon : new Persoon();
            editPersoonDialog.ShowDialog(persoon, rollenList, PersonenGrid);
            return;
        }
        if (args.Item.Id == "send-email")
        {
            // TODO:
            // get a list of all persons to send email to
            // pass it to next funtion
            ShowSendMailDialog();
            return;
        }

    }

    // Everything to handle persons
    public List<RolTypeEnum> selectedRollen;
    public List<Persoon> personenList = new List<Persoon>();
    public List<Rol> rollenList = new List<Rol>();
    SfGrid<Persoon> PersonenGrid;
    public List<double> SelectedRowIndexes { get; set; }
    public double[] TotalValue { get; set; }
    public string SelectedValue;        

    protected override void OnInitialized()
    {
        base.OnInitialized();
        selectedRollen = RolContext.ToList<RolTypeEnum>();
        rollenList = GetRollen();
        RefreshList();
    }

    private void ValueRemovedHandler(Syncfusion.Blazor.DropDowns.RemoveEventArgs<Rol> args) 
    { 
        selectedRollen.Remove(args.ItemData.Id);
        RefreshList();
    } 

    private void OnValueSelectHandler(Syncfusion.Blazor.DropDowns.SelectEventArgs<Rol> args) 
    { 
        selectedRollen.Add(args.ItemData.Id);
        RefreshList();
    } 

    private void ClearedHandler(MouseEventArgs args)
    {
        selectedRollen = new List<RolTypeEnum>();
        RefreshList();
    }

    public async Task GetSelectedRecords(RowSelectEventArgs<Persoon> args)
    {
        SelectedRowIndexes = await this.PersonenGrid.GetSelectedRowIndexes();
        TotalValue = SelectedRowIndexes.ToArray();
        SelectedValue = "";
        foreach (var data in TotalValue)
        {
            SelectedValue = SelectedValue + " " + data;
        }
        StateHasChanged();
    }

    public void ActionCompletedHandler(ActionEventArgs<Persoon> args)
    {
        // Here you can customize your code
    }    
    public Task RefreshList()
    {
        // refresh with value from multiselect dropdown box
        if (selectedRollen == null || selectedRollen.Count<RolTypeEnum>() == 0)
        {
            personenList = new List<Persoon>();
        }
        else
        {
            personenList = GetPersonen(selectedRollen).OrderBy(p => p.Achternaam).ToList<Persoon>();
        }
        return Task.CompletedTask;
    }

    private List<Persoon> GetPersonen(List<RolTypeEnum> rolTypes)
    {
        var personen = new List<Persoon>();

        if (rolTypes.Contains(RolTypeEnum.Alle))
        {
            // special case, also show persons with no role
            personen = persoonService
                        .GetPersonen()
                        .ToList<Persoon>();
        }
        else
        {
            // select persons with specified rol only
            var currentRollen = rollenList
                                .Where(r => rolTypes.Contains(r.Id))
                                .ToList<Rol>();

            personen = persoonService
                        .GetPersonen()
                        .Where(p => !p.IsVerwijderd)
                        .Where(p => p.Rollen.FirstOrDefault(r => rolTypes.Contains(r.Id) ) != null)
                        .ToList<Persoon>();
        }
        return personen;
    }

    private List<Rol> GetRollen()
    {
        // TODO 
        // Get list of all rollen based on enum
        var rollenList = rolService
                        .GetRollen()
                        .OrderBy(r => r.Beschrijving)
                        .ToList<Rol>();
        return rollenList;
    }

}

