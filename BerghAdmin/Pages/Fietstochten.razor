@page "/Fietsers/Tochten"

@using BerghAdmin.Authorization
@using BerghAdmin.Data
@using BerghAdmin.Services.Evenementen

@inject IJSRuntime jsRuntime
@inject BerghAdmin.Services.IPersoonService persoonService
@inject BerghAdmin.Services.Evenementen.IEvenementService evenementService

@inject NavigationManager NavigationManager
@inject IJSRuntime jsRuntime

@attribute [Authorize(Policy = "IsBeheerFietsers")]

<h3>Fietstochten</h3>

@*
    The grid showing all fietstochten
*@
<SfGrid @ref="@FietsTochtGrid" DataSource="@FietsTochtList" SelectedRowIndex=0>
    <GridEditSettings 
        AllowAdding="true" 
        AllowDeleting="true" 
        AllowEditing="true" 
        Mode="EditMode.Dialog" 
        AllowEditOnDblClick="true">
    </GridEditSettings>
    <GridEvents RowSelected="SelectFietsTocht" TValue="FietsTocht" />
    <GridColumns>
        <GridColumn Field=@nameof(FietsTocht.Id) HeaderText="Id" TextAlign="TextAlign.Left" Width="0" IsPrimaryKey="true"></GridColumn>
        <GridColumn Field=@nameof(FietsTocht.Titel) HeaderText="Titel" TextAlign="TextAlign.Left"  Width="110"></GridColumn>
        <GridColumn Field=@nameof(FietsTocht.GeplandeDatum) HeaderText="Datum" Format="d" Type="ColumnType.Date" TextAlign="TextAlign.Left"  Width="70"></GridColumn>
        <GridColumn Field=@nameof(FietsTocht.AantalDeelnemers) HeaderText="# deelnemers" TextAlign="TextAlign.Left"  Width="120"></GridColumn>
    </GridColumns>
</SfGrid>

<br />
<div class='e-statustext'>Deelnemers aan fietstocht: <b>@SelectedFietsTocht.Titel</b></div>
<SfGrid @ref="@DeelnemersGrid" DataSource="@DeelnemerList"
    ContextMenuItems="@(new List<ContextMenuItemModel>() { 
                            new ContextMenuItemModel { Text = "Toevoegen Deelnemer", Target = ".e-content", Id = "add-deelnemer" },
                            new ContextMenuItemModel { Text = "Verwijderen Deelnemer", Target = ".e-content", Id = "delete-deelnemer" },
                            new ContextMenuItemModel { Text = "Toon Deelnemer", Target = ".e-content", Id = "toon-donaties" },
                        })">
    <GridEvents ContextMenuItemClicked="OnContextMenuClick" TValue="Persoon" />
    <GridSortSettings>
        <GridSortColumns>
            <GridSortColumn Field="VolledigeNaam" Direction="SortDirection.Ascending"></GridSortColumn>
        </GridSortColumns>
    </GridSortSettings>
   <GridColumns>
        <GridColumn Field=@nameof(Persoon.VolledigeNaam) HeaderText="Naam" TextAlign="TextAlign.Left"  Width="110" />
        <GridColumn Field=@nameof(Persoon.GeboorteDatum) HeaderText="Geb.datum" Format="d" Type="ColumnType.Date" TextAlign="TextAlign.Left" Width="70" />
        <GridColumn Field=@nameof(Persoon.Mobiel) HeaderText="Mobiel" TextAlign="TextAlign.Left"  Width="70" />
        <GridColumn Field=@nameof(Persoon.EmailAdres) HeaderText="Email" TextAlign="TextAlign.Left"  Width="120" />
        <GridColumn Field=@nameof(Persoon.GetDonatieBedrag) HeaderText="Totaal" TextAlign="TextAlign.Left"  Width="50" />
        <GridColumn Field=@nameof(Persoon.GetRollenAsString) HeaderText="Rollen" TextAlign="TextAlign.Left"  Width="200" />
    </GridColumns>
</SfGrid>

<SelectFietserDialog @ref="selectFietserDialog"></SelectFietserDialog>
<ShowDonatiesDialog @ref="showDonatiesDialog"></ShowDonatiesDialog>

@code
{
    // Everything to handle persons
    public IEnumerable<FietsTocht> FietsTochtList = new List<FietsTocht>();
    public IEnumerable<Persoon> DeelnemerList { get; set; } = new List<Persoon>();
    public FietsTocht SelectedFietsTocht { get; set; } = new();
    SfGrid<Persoon> DeelnemersGrid = new();
    SfGrid<FietsTocht> FietsTochtGrid = new();

    // Everything to handle the sow donaties dialog
    ShowDonatiesDialog showDonatiesDialog = new();
    private void ShowDonatiesDialog(Persoon persoon)
    {
        showDonatiesDialog.Persoon = persoon;
        showDonatiesDialog.DialogOpen();
    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        await jsRuntime.InvokeAsync<object>("SetSideMenu", "fietser");
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        RefreshList();
    }

    public void SelectFietsTocht(RowSelectEventArgs<FietsTocht> args)
    {
        SelectedFietsTocht = args.Data;
        DeelnemerList = SelectedFietsTocht
                            .Deelnemers
                            .OrderBy(d => d.VolledigeNaam);
    }

    public void ActionCompletedHandler(ActionEventArgs<FietsTocht> args)
    {
        // Here you can customize your code
    }

    public Task RefreshList()
    {
        FietsTochtList = GetFietsTochten();
        if (SelectedFietsTocht == null)
        {
            SelectedFietsTocht = FietsTochtList.ElementAt(0);
        }
        if (SelectedFietsTocht != null)
        {
            DeelnemerList = SelectedFietsTocht
                            .Deelnemers
                            .OrderBy(d => d.VolledigeNaam);
        }   
        
        return Task.CompletedTask;
    }

    private IEnumerable<FietsTocht> GetFietsTochten()
    {
        var fietsTochten = evenementService
                    .GetAllFietsTochten()
                    .OrderByDescending(ft => ft.GeplandeDatum)
                    .ToList<FietsTocht>();

        return fietsTochten;
    }

    // Everything to handle the email dialog
    SelectFietserDialog selectFietserDialog = new();

    // Everything to handle the edit persoon dialog
    EditPersoonDialog editPersoonDialog = new();

    // Everything to handle the context menu
    // Triggers when the item is selected
    public async Task OnContextMenuClick(ContextMenuClickEventArgs<Persoon> args)
    {
        if (args.Item.Id == "add-deelnemer")
        {
            selectFietserDialog.ShowDialog(SelectedFietsTocht, DeelnemersGrid, FietsTochtGrid);
            return;
        }
        if (args.Item.Id == "delete-deelnemer")
        {
            var persoon = args.RowInfo.RowData as Persoon;
            if (persoon == null)
                return;

            await evenementService.DeleteDeelnemer(SelectedFietsTocht, persoon);
            await RefreshList();
            DeelnemersGrid.Refresh();

            return;
        }
        if (args.Item.Id == "toon-donaties")
        {
            var persoon = args.RowInfo.RowData as Persoon;
            if (persoon == null)
                return;
            ShowDonatiesDialog(persoon);
            return;
        }
    }

}
