@page "/add-fietsers-to-fietstocht-dialog"

@using BerghAdmin.Events
@using Microsoft.AspNetCore.Components;
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Popups

@attribute [Authorize(Policy = "IsBeheerFietsers")]

<SfDialog Width="75%" IsModal="true" ShowCloseIcon="true" @bind-Visible="@IsVisible">
    <DialogEvents OnOverlayModalClick="@OnOverlayModalClick" Opened="@Opened" />
    <DialogTemplates>
        <Header> Selecteer toe te voegen fietsers </Header>
        <Content>
            <EditForm Model="@_currentPersoon">
                <SfListBox @ref="_personenListBox"
                            TValue="PersoonListItem[]"
                            TItem="PersoonListItem"
                            DataSource="@_teSelecterenPersonenArray"
                            @bind-Value="_geselecteerdePersonenArray">
                    <ListBoxFieldSettings Text="VolledigeNaamEmail" Value="Id" />
                    <ListBoxSelectionSettings ShowCheckbox="true" />
                </SfListBox>
            </EditForm>
        </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="Opslaan en sluiten" IsPrimary="true" OnClick="@SaveAndClose" />
        <DialogButton Content="Afbreken" IsPrimary="false" OnClick="@DialogClose" />
    </DialogButtons>
</SfDialog>

@code {
    [Parameter]
    public EventCallback<FietsersAddedEventArgs> OnFietsersAdded { get; set; }

    SfListBox<PersoonListItem[], PersoonListItem>? _personenListBox;
    private PersoonListItem[] _teSelecterenPersonenArray = new PersoonListItem[] { };
    private PersoonListItem[] _geselecteerdePersonenArray = new PersoonListItem[] { };
    private PersoonListItem _currentPersoon = new();

    public bool IsVisible { get; set; } = false;

    public void DialogOpen(PersoonListItem[] teSelecterenPersonen)
    {
        _teSelecterenPersonenArray = teSelecterenPersonen;
        IsVisible = true;
        StateHasChanged();
    }

    private async Task Opened(Syncfusion.Blazor.Popups.OpenEventArgs args)
    {
        args.PreventFocus = true;
    }

    private async Task SaveAndClose()
    {
        // temporary
        var returnList = new Persoon[] { };
        await OnFietsersAdded.InvokeAsync(new FietsersAddedEventArgs(_geselecteerdePersonenArray));

        DialogClose();
    }

    private void DialogClose()
    {
        IsVisible = false;
        StateHasChanged();
    }

    private void OnOverlayModalClick(OverlayModalClickEventArgs args)
    {
        DialogClose();
    }

}